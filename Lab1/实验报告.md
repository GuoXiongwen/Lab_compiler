[TOC]

### 实验流程

1. 根据官方文档《SysY语言定义》确定对于关键字/标识符/常量的表示文法以及SysY中算符有哪些，编写不同分类的正则表达式
2. 研究如何记录行号和列号以及如何识别不符合词法的语句
3. 在6个测试文件中运行并测试，进行查缺补漏

### 词法分类规则

#### 关键字 K

类型仅有 `int` 和 `void`，然后加上声明/逻辑控制等关键字，此外，虽然测试文件中不包含 `true` 和 `false` 关键字，**但是由于SysY支持逻辑运算，所以我添加了 `true` 和 `false` 作为关键字**

值得一提的是，对于 `main`，理论上既可以视为关键字也可以视为函数名（标识符），**鉴于 example 将其视为关键字，所以我也将其视为关键字**

#### 标识符 I

根据SysY文档第3页的上下无关文法编写即可

#### 常量 C

根据SysY文档第4页的上下无关文法编写即可

#### 算符 O

SysY支持算术运算、逻辑运算和关系运算，而并未提及位运算，所以我**并未将位运算的运算符考虑在内**

#### 界符 D

包括：逗号，分号，大中小括号

值得一提的是，`[]` 理论上既可以视为界符也可以视为数组的取址运算符，**鉴于 example 将其视为界符，所以我也将其视为界符**

#### 其他 T

**包含：注释和不符合词法的语句**，对于不符合词法的语句的识别方法见下一节

### 识别不符合词法的语句

#### 先说FLEX识别规则的性质

##### 正则表达式的最长匹配规则（贪婪匹配）

以 `value1` 这个变量名（标识符）为例，与标识符相关的正则表达式会选择匹配整个 `value1` 字符串而不是仅仅匹配前面的几个字符

##### 根据在FLEX出现的识别规则先后进行匹配

每条识别规则由正则表达式和相应的动作组成，但是**可能有多条识别规则的正则表达式能够识别同一个字符串，但是FLEX程序只能执行一个动作，这时会执行最先出现的识别规则中的动作**，例如，**其实所有的关键字都能够被标识符的正则表达式识别，因此必须将关键字的识别规则放到标识符的识别规则之前**

参考：

#### 利用前述性质识别不符合词法的语句

很简单地，只需要将关键字/标识符/常量/运算符/界限符/注释的识别规则写在前面，然后定义正则表达式 `WHOLE=[a-zA-Z0-9]+`，这个表达式虽然可以匹配关键字/标识符/常量，但是由于关键字/标识符/常量的识别规则在前，所以**只有符合 `WHOLE` 表达式但是不符合关键字/标识符/常量的正则表达式的字符串会被视为不符合词法的语句而被认作 “其他”**

### 记录行号和列号

注意这里的行号和列号都是从1开始的

记录行号：打开 `%option yylineno` 选项则FLEX程序会自动维护当前行号 `yylineno`，所以可以直接使用 `yylineno` 变量

记录列号：维护全局变量 `col` 并初始化为1，在匹配到关键字/标识符/常量/运算符/界限符/单行不符合词法的语句/单行注释之后，会更新 `col` （`col += yyleng;`），在匹配到除了前述字符串和换行符之外的其余单个字符，也会更新 `col` （`col += 1;`）；在匹配到换行符之后，会将 ` col` 重置为1

**注意 `\t` 制表符如果不特殊指定的话，会被识别为1个字符，从而使得 `col += 1`，但是我们想要将其视为4个空格符，所以需要特殊指定一下**

### 编译运行

以 `6.sy` 文件为例，其余同理

```sh
flex myla.l
gcc lex.yy.c -o a
# test/6.sy 为待分析的SysY文件
# 将输出结果管道给 6.txt 文件
./a < test/6.sy | tee 6.txt

rm a lex.yy.c
```

### 附件列表

`myla.l`：FLEX文件





